name: Generate Release Notes

on:
  push:
    branches: 
      - main
      - master
    paths-ignore:
      - 'README.md'
      - '.github/workflows/**'

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Preparar repositório BookSys (Privado)
        env:
          # Usa BOOKSYS_TOKEN se disponível, senão usa GITHUB_TOKEN
          # IMPORTANTE: Se BookSys for de outro usuário/org, crie um PAT e configure como BOOKSYS_TOKEN
          BOOKSYS_TOKEN: ${{ secrets.BOOKSYS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ${{ github.workspace }}/repos
          cd ${{ github.workspace }}/repos
          
          # Valida se o token está disponível
          if [ -z "${BOOKSYS_TOKEN}" ]; then
            echo "❌ ERRO: Token não configurado para acessar repositório privado BookSys"
            echo "Configure um secret 'BOOKSYS_TOKEN' ou 'GITHUB_TOKEN' com permissão de acesso ao repositório"
            exit 1
          fi
          
          if [ ! -d "BookSys" ]; then
            echo "Clonando repositório BookSys (privado)..."
            # Clona usando token (repositório privado)
            git clone https://x-access-token:${BOOKSYS_TOKEN}@github.com/schneiderjaoo/bookSys.git BookSys || {
              echo "❌ Erro: Não foi possível clonar o repositório BookSys"
              echo ""
              echo "Possíveis causas:"
              echo "  1. O token não tem permissão para acessar o repositório privado"
              echo "  2. O repositório não existe ou está inacessível"
              echo ""
              echo "Solução:"
              echo "  - Crie um Personal Access Token (PAT) com escopo 'repo'"
              echo "  - Adicione como secret 'BOOKSYS_TOKEN' no GitHub"
              echo "  - Verifique se o token tem acesso ao repositório schneiderjaoo/bookSys"
              exit 1
            }
            echo "✅ Repositório BookSys clonado com sucesso"
          else
            echo "Repositório BookSys já existe. Atualizando..."
            cd BookSys
            git remote set-url origin https://x-access-token:${BOOKSYS_TOKEN}@github.com/schneiderjaoo/bookSys.git
            git fetch origin
            git checkout main || git checkout master
            git pull origin main || git pull origin master
          fi
          
          # Configura credenciais para push no repositório BookSys
          cd ${{ github.workspace }}/repos/BookSys
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          # Garante que o remote está configurado com token para push
          git remote set-url origin https://x-access-token:${BOOKSYS_TOKEN}@github.com/schneiderjaoo/bookSys.git

      - name: Validar e preparar configuração MongoDB
        run: |
          if [ -z "${{ secrets.MONGODB_URI }}" ]; then
            echo "❌ ERRO: MONGODB_URI não está configurado nos secrets do GitHub"
            echo "Configure em: Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          # Verifica se a URI começa com mongodb:// ou mongodb+srv://
          MONGODB_URI="${{ secrets.MONGODB_URI }}"
          if [[ ! "$MONGODB_URI" =~ ^mongodb ]] && [[ ! "$MONGODB_URI" =~ ^mongodb\+srv ]]; then
            echo "❌ ERRO: MONGODB_URI inválido. Deve começar com 'mongodb://' ou 'mongodb+srv://'"
            echo "URI atual: ${MONGODB_URI:0:50}..."
            exit 1
          fi
          
          # Verifica se o nome do banco está na URI ou será fornecido separadamente
          MONGODB_DB="${{ secrets.MONGODB_DATABASE }}"
          if [ -z "$MONGODB_DB" ]; then
            echo "⚠️  AVISO: MONGODB_DATABASE não configurado. Usando 'Cluster0' como padrão."
            echo "MONGODB_DATABASE=Cluster0" >> $GITHUB_ENV
          else
            echo "MONGODB_DATABASE=$MONGODB_DB" >> $GITHUB_ENV
          fi
          
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "⚠️  AVISO: GEMINI_API_KEY não está configurado. Release notes inteligentes podem falhar."
          fi
          
          echo "✅ Secrets validados"

      - name: Run Release Notes Generator
        env:
          # MongoDB - A URI deve começar com mongodb:// ou mongodb+srv://
          # IMPORTANTE: Se a URI não incluir o nome do banco, use MONGODB_DATABASE separadamente
          # Formato completo: mongodb+srv://user:pass@cluster.mongodb.net/DATABASE_NAME?appName=...
          SPRING_DATA_MONGODB_URI: ${{ secrets.MONGODB_URI }}
          SPRING_DATA_MONGODB_DATABASE: ${{ env.MONGODB_DATABASE || secrets.MONGODB_DATABASE || 'Cluster0' }}
          
          # Gemini API (opcional, mas recomendado)
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Configurações do repositório BookSys
          APP_REPO_BOOKSYS_PATH: ${{ github.workspace }}/repos/BookSys
          APP_REPO_BOOKSYS_RELEASE_NOTES_DIR: 'books/release-notes/Diário de Mudanças'
          APP_REPO_BOOKSYS_URL: 'https://github.com/schneiderjaoo/bookSys.git'
        run: |
          echo "Iniciando geração de release notes..."
          echo "MongoDB URI configurada: ${SPRING_DATA_MONGODB_URI:0:50}..."
          echo "MongoDB Database: $SPRING_DATA_MONGODB_DATABASE"
          java -jar target/git-0.0.1-SNAPSHOT.jar

      - name: Verificar arquivos criados
        run: |
          echo "Verificando arquivos de release notes criados..."
          ls -la ${{ github.workspace }}/repos/BookSys/books/release-notes/Diário\ de\ Mudanças/*.md | tail -5 || echo "Nenhum arquivo encontrado"

